name: TITAN Continuous Deployment

on:
  push:
    branches: ["main"]

env:
  PROJECT_ID: evidentedesarrollo # <--- CONFIRMA QUE ESTE ES TU ID EXACTO
  REGION: us-central1
  REPO_NAME: titan-repo
  SERVICE_NAME: titan-backend
  IMAGE_NAME: titan-backend

jobs:
  deploy:
    name: Build and Deploy to Cloud Run
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”‘ Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ðŸ› ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ðŸ³ Docker Auth
        run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: ðŸ—ï¸ Build and Push Container
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: ðŸš€ Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          # DefiniciÃ³n de variables de entorno y conexiÃ³n a DB
          env_vars: |
            ENVIRONMENT=production
            POSTGRES_USER=titan_user
            POSTGRES_DB=titan_db
            POSTGRES_SERVER=none
            INSTANCE_CONNECTION_NAME=evidentedesarrollo:us-central1:titan-db-prod
            LANGCHAIN_TRACING_V2=true
            LANGCHAIN_PROJECT=TITAN-Platform

          secrets: |
            POSTGRES_PASSWORD=POSTGRES_PASSWORD
            TAVILY_API_KEY=TAVILY_API_KEY
            LANGCHAIN_API_KEY=LANGCHAIN_API_KEY
